# GitHub Actions 流水线检测指南

## 概述

这个项目包含多个脚本来帮助你管理Git标签和检测GitHub Actions流水线状态：

1. **`recreate-tag.sh`** - 重建Git标签并检测流水线状态
2. **`check-pipeline.sh`** - 独立的流水线状态检测工具
3. **`test-build.sh`** - 本地构建测试脚本
4. **`upload-release.sh`** - 手动上传Release资产
5. **`complete-release.sh`** - 完整的发布流程管理

## 功能特性

### 🔄 标签重建 (`recreate-tag.sh`)
- 删除本地和远程标签
- 重新创建并推送标签
- 自动检测GitHub Actions流水线状态
- 支持交互式选择检测方式
- 提供详细的执行反馈

### 📊 流水线检测 (`check-pipeline.sh`)
- 快速检测当前流水线状态
- 显示最近的流水线运行历史
- 支持等待流水线完成
- 多种检测方式（GitHub CLI / API）

### 🔨 本地构建测试 (`test-build.sh`)
- 清理和重新构建项目
- 验证构建配置正确性
- 检查生成的可执行文件
- 提供构建结果分析

### 📤 手动上传 (`upload-release.sh`)
- 手动上传Release资产
- 带重试机制的可靠上传
- 支持创建新Release
- 详细的上传状态反馈

### 🎯 完整流程 (`complete-release.sh`)
- 交互式发布流程管理
- 整合所有发布步骤
- 提供选择性执行选项
- 自动化完整发布流程

## 安装要求

### 必需工具
- **Git** - 版本控制
- **Bash** - 脚本执行环境

### 推荐工具
- **GitHub CLI (`gh`)** - 提供最佳的流水线检测体验
  ```bash
  # macOS
  brew install gh
  
  # 认证
  gh auth login
  ```

### 备用工具
- **curl** - 用于API检测（功能有限）

## 使用方法

### 1. 完整发布流程（推荐）

```bash
./complete-release.sh
```

这个脚本提供交互式菜单，包含：
- 本地构建测试
- 标签重建和推送
- 流水线状态检测
- 手动资产上传
- 完整自动化流程

### 2. 重建标签并检测流水线

```bash
./recreate-tag.sh
```

脚本会：
1. 删除本地标签 `v1.0.0`
2. 删除远程标签 `v1.0.0`
3. 重新创建本地标签
4. 推送标签到远程仓库
5. 检测GitHub Actions流水线状态

### 3. 仅检测流水线状态

```bash
./check-pipeline.sh
```

这个脚本会：
- 显示最近的流水线运行状态
- 检测当前是否有运行中的流水线
- 可选择等待流水线完成

### 4. 本地构建测试

```bash
./test-build.sh
```

在推送标签前验证构建：
- 清理构建目录
- 配置和构建项目
- 验证生成的文件
- 提供构建结果分析

### 5. 手动上传Release资产

```bash
./upload-release.sh <文件路径> [标签名]
```

当GitHub Actions上传失败时的备用方案：
- 支持重试机制
- 自动创建Release（如果不存在）
- 详细的错误诊断

## 配置选项

### `recreate-tag.sh` 配置

在脚本顶部可以修改以下配置：

```bash
TAG_NAME="v1.0.0"                    # 要重建的标签名
REMOTE_NAME="origin"                 # 远程仓库名
PIPELINE_CHECK_TIMEOUT=300           # 流水线检测超时时间（秒）
PIPELINE_CHECK_INTERVAL=10           # 检测间隔（秒）
```

### `check-pipeline.sh` 配置

```bash
REMOTE_NAME="origin"                 # 远程仓库名
CHECK_TIMEOUT=60                     # 检测超时时间（秒）
CHECK_INTERVAL=5                     # 检测间隔（秒）
```

## 检测方式

### 方式1: GitHub CLI (推荐)
- ✅ 详细的流水线信息
- ✅ 实时状态更新
- ✅ 完整的错误信息
- ✅ 直接链接到具体运行

**要求**: 安装并认证GitHub CLI

### 方式2: GitHub API
- ✅ 无需额外工具
- ⚠️ 功能有限
- ⚠️ 私有仓库可能受限

**要求**: 仅需curl

### 方式3: 手动检查
- 提供GitHub Actions页面链接
- 用户手动访问检查

## 输出说明

### 状态指示器
- 🟢 `✓` - 成功/完成
- 🔴 `✗` - 失败/错误
- 🟡 `⚠️` - 警告/注意
- 🔵 `⏳` - 进行中/等待

### 流水线状态
- **成功** - 流水线执行成功
- **失败** - 流水线执行失败
- **运行中** - 流水线正在执行
- **队列中** - 流水线等待执行
- **已取消** - 流水线被取消

## 故障排除

### 常见问题

#### 1. GitHub CLI未认证
```bash
# 错误信息
⚠️ GitHub CLI 未认证，无法检测流水线状态

# 解决方案
gh auth login
```

#### 2. 无法访问GitHub API
```bash
# 错误信息
✗ 无法访问GitHub API

# 可能原因
- 网络连接问题
- 私有仓库权限限制
- API速率限制

# 解决方案
- 检查网络连接
- 使用GitHub CLI
- 等待后重试
```

#### 3. 标签推送失败
```bash
# 错误信息
✗ 标签推送失败

# 可能原因
- 权限不足
- 网络问题
- 远程仓库不存在

# 解决方案
- 检查Git凭据
- 验证仓库权限
- 手动推送测试
```

### 调试模式

如果遇到问题，可以启用详细输出：

```bash
# 启用bash调试
bash -x ./recreate-tag.sh

# 或者
bash -x ./check-pipeline.sh
```

## 最佳实践

### 1. 使用前检查
- 确保在正确的Git仓库中
- 验证远程仓库连接
- 检查当前分支状态

### 2. 标签管理
- 在重建标签前备份重要信息
- 确认标签指向正确的提交
- 通知团队成员标签变更

### 3. 流水线监控
- 定期检查流水线状态
- 关注失败的流水线
- 及时处理构建问题

## 扩展功能

### 自定义标签名
修改脚本中的 `TAG_NAME` 变量，或者创建参数化版本：

```bash
# 支持命令行参数的版本
TAG_NAME=${1:-"v1.0.0"}
```

### 多仓库支持
可以扩展脚本支持多个仓库的批量操作。

### 通知集成
可以集成Slack、邮件等通知方式，在流水线完成时发送通知。

## 许可证

这些脚本遵循项目的许可证条款。

## 贡献

欢迎提交问题报告和改进建议！