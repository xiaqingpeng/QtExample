name: Qt Release (Lite)

on:
  push:
    tags:
      - 'v*.*.*-lite'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        qt_version: ['6.6.1']
        include:
          - os: macos-latest
            qt_arch: clang_64
            archive_ext: zip
            cmake_generator: "Ninja"
            cmake_config: Release
          - os: ubuntu-latest
            qt_arch: gcc_64
            archive_ext: tar.gz
            cmake_generator: Ninja
            cmake_config: Release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Free up disk space (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        df -h

    - name: Setup Qt Cache
      uses: actions/cache@v4
      with:
        path: |
          ${{ runner.temp }}/Qt
        key: ${{ runner.os }}-Qt-${{ matrix.qt_version }}-lite-v1
        restore-keys: |
          ${{ runner.os }}-Qt-${{ matrix.qt_version }}-

    - name: Install Qt (Minimal)
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ matrix.qt_version }}
        target: desktop
        arch: ${{ matrix.qt_arch }}
        cache: true
        cache-key-prefix: 'install-qt-lite'
        modules: 'qtwebengine'  # åªå®‰è£…å¿…éœ€çš„æ¨¡å—
        setup-python: false
      timeout-minutes: 25

    - name: Install system dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ninja-build \
          libgl1-mesa-dev \
          libxcb-xinerama0 \
          libxcb-cursor0 \
          libfontconfig1 \
          libxkbcommon-x11-0

    - name: Configure CMake
      run: |
        if [ "$RUNNER_OS" == "macOS" ]; then
          cmake -B build -G "${{ matrix.cmake_generator }}" \
            -DCMAKE_BUILD_TYPE=${{ matrix.cmake_config }} \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET="10.15"
        else
          cmake -B build -G "${{ matrix.cmake_generator }}" \
            -DCMAKE_BUILD_TYPE=${{ matrix.cmake_config }} \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DCMAKE_CXX_STANDARD=17
        fi
      shell: bash
      timeout-minutes: 5

    - name: Build project
      run: |
        cmake --build build --config ${{ matrix.cmake_config }} --parallel
      timeout-minutes: 15

    - name: Package application
      env:
        ARCHIVE_NAME: example-${{ github.ref_name }}-${{ runner.os }}-qt${{ matrix.qt_version }}
      run: |
        mkdir -p "$ARCHIVE_NAME"
        
        # è°ƒè¯•ï¼šåˆ—å‡ºbuildç›®å½•å†…å®¹
        echo "=== Build directory contents ==="
        ls -la build/
        
        if [ "$RUNNER_OS" == "macOS" ]; then
          cp -R build/example.app "$ARCHIVE_NAME/"
          cp -r images "$ARCHIVE_NAME/" || echo "Images directory not found"
          zip -r "$ARCHIVE_NAME.zip" "$ARCHIVE_NAME"
          echo "ASSET_PATH=$ARCHIVE_NAME.zip" >> $GITHUB_ENV
        else
          cp build/example "$ARCHIVE_NAME/"
          cp build/*.so* "$ARCHIVE_NAME/" 2>/dev/null || true
          cp -r images "$ARCHIVE_NAME/" || echo "Images directory not found"
          tar -czf "$ARCHIVE_NAME.tar.gz" "$ARCHIVE_NAME"
          echo "ASSET_PATH=$ARCHIVE_NAME.tar.gz" >> $GITHUB_ENV
        fi
      shell: bash

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ env.ASSET_PATH }}
        draft: false
        prerelease: true  # æ ‡è®°ä¸ºé¢„å‘å¸ƒ
        generate_release_notes: true
        fail_on_unmatched_files: true
        make_latest: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      timeout-minutes: 10
      
    - name: Verify Release Upload
      if: success()
      run: |
        echo "âœ… Release asset uploaded successfully: ${{ env.ASSET_PATH }}"
        echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
      
    - name: Handle Upload Failure
      if: failure()
      run: |
        echo "âŒ Release upload failed for ${{ env.ASSET_PATH }}"
        echo "ðŸ” Troubleshooting steps:"
        echo "  1. Check file exists: ls -la ${{ env.ASSET_PATH }}"
        echo "  2. Check file size: du -h ${{ env.ASSET_PATH }}"
        echo "  3. Verify GitHub token permissions"
        echo "  4. Check GitHub API status: https://www.githubstatus.com/"
        ls -la ${{ env.ASSET_PATH }} || echo "File not found!"
        du -h ${{ env.ASSET_PATH }} || echo "Cannot get file size!"
        
    - name: Retry Upload with GitHub CLI
      if: failure()
      run: |
        echo "ðŸ”„ Attempting upload with GitHub CLI..."
        if command -v gh &> /dev/null; then
          gh release upload ${{ github.ref_name }} ${{ env.ASSET_PATH }} --clobber || echo "GitHub CLI upload also failed"
        else
          echo "GitHub CLI not available for retry"
        fi