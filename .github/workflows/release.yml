name: Qt Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        qt_version: ['6.6.1']
        include:
          - os: windows-latest
            qt_arch: win64_msvc2019_64
            archive_ext: zip
            cmake_generator: "Ninja"
            cmake_config: Release
          - os: macos-latest
            qt_arch: clang_64
            archive_ext: zip
            cmake_generator: "Ninja"
            cmake_config: Release
          - os: ubuntu-latest
            qt_arch: gcc_64
            archive_ext: tar.gz
            cmake_generator: Ninja
            cmake_config: Release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ matrix.qt_version }}
        target: desktop
        arch: ${{ matrix.qt_arch }}
        cache: true
        modules: 'qtwebengine qtwebchannel qtpositioning'

    - name: Install system dependencies (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ninja-build \
          libgl1-mesa-dev \
          libxcb-xinerama0 \
          libxcb-cursor0 \
          libfontconfig1 \
          libxkbcommon-x11-0

    - name: Setup MSVC environment (Windows)
      if: matrix.os == 'windows-latest'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Configure CMake
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          cmake -B build -G "${{ matrix.cmake_generator }}" \
            -DCMAKE_BUILD_TYPE=${{ matrix.cmake_config }} \
            -DCMAKE_PREFIX_PATH="$env:Qt6_DIR" \
            -DCMAKE_CXX_STANDARD=17
        elif [ "$RUNNER_OS" == "macOS" ]; then
          cmake -B build -G "${{ matrix.cmake_generator }}" \
            -DCMAKE_BUILD_TYPE=${{ matrix.cmake_config }} \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DCMAKE_CXX_STANDARD=17 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET="10.15"
        else
          cmake -B build -G "${{ matrix.cmake_generator }}" \
            -DCMAKE_BUILD_TYPE=${{ matrix.cmake_config }} \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DCMAKE_CXX_STANDARD=17
        fi
      shell: bash

    - name: Build project
      run: |
        cmake --build build --config ${{ matrix.cmake_config }} --parallel

    - name: Package application
      id: package
      env:
        ARCHIVE_NAME: example-${{ github.ref_name }}-${{ runner.os }}-qt${{ matrix.qt_version }}
      run: |
        if [ "$RUNNER_OS" == "Windows" ]; then
          mkdir -p "$env:ARCHIVE_NAME"
          cp build/example.exe "$env:ARCHIVE_NAME/"
          cp build/*.dll "$env:ARCHIVE_NAME/" 2>/dev/null || true
          cp -r images "$env:ARCHIVE_NAME/"
          Compress-Archive -Path "$env:ARCHIVE_NAME" -DestinationPath "$env:ARCHIVE_NAME.zip" -Force
          echo "ASSET_PATH=$env:ARCHIVE_NAME.zip" >> $env:GITHUB_ENV
        elif [ "$RUNNER_OS" == "macOS" ]; then
          mkdir -p "$ARCHIVE_NAME"
          cp -R build/example.app "$ARCHIVE_NAME/"
          cp -r images "$ARCHIVE_NAME/"
          zip -r "$ARCHIVE_NAME.zip" "$ARCHIVE_NAME"
          echo "ASSET_PATH=$ARCHIVE_NAME.zip" >> $GITHUB_ENV
        else
          mkdir -p "$ARCHIVE_NAME"
          cp build/example "$ARCHIVE_NAME/"
          cp build/*.so* "$ARCHIVE_NAME/" 2>/dev/null || true
          cp -r images "$ARCHIVE_NAME/"
          tar -czf "$ARCHIVE_NAME.tar.gz" "$ARCHIVE_NAME"
          echo "ASSET_PATH=$ARCHIVE_NAME.tar.gz" >> $GITHUB_ENV
        fi
      shell: bash

    - name: Upload Release Asset
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ env.ASSET_PATH }}
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
