name: Linux Build

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - '.github/**'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
      - '.github/**'

jobs:
  build:
    name: Build Qt6 on Linux
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        qt_version: ['6.5.3', '6.6.1']
        include:
          - qt_version: '6.5.3'
            qt_arch: 'gcc_64'
          - qt_version: '6.6.1'
            qt_arch: 'gcc_64'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ninja-build \
          libgl1-mesa-dev \
          libxcb-xinerama0 \
          libxcb-cursor0 \
          libfontconfig1 \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-shape0 \
          libxcb-xfixes0 \
          libxcb-xkb1 \
          libxcb-sync1 \
          libxcb-xinerama0
    
    - name: Cache Qt installation
      uses: actions/cache@v3
      with:
        path: ${{ env.Qt6_DIR }}
        key: ${{ runner.os }}-qt-${{ matrix.qt_version }}-${{ matrix.qt_arch }}
        restore-keys: |
          ${{ runner.os }}-qt-${{ matrix.qt_version }}-
          ${{ runner.os }}-qt-
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ matrix.qt_version }}
        target: desktop
        arch: ${{ matrix.qt_arch }}
        cache: true
        modules: 'qtwebengine qtnetworkauth'
    
    - name: Configure CMake
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
          -DCMAKE_CXX_STANDARD=17
    
    - name: Build project
      run: |
        cmake --build build --config Release --parallel
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: example-linux-${{ matrix.qt_version }}
        path: |
          build/example
          build/*.so*
        retention-days: 7
    
    - name: Package application
      if: startsWith(github.ref, 'refs/tags/')
      run: |
        ARCHIVE_NAME="example-${{ github.ref_name }}-linux-qt${{ matrix.qt_version }}"
        mkdir -p "$ARCHIVE_NAME"
        cp build/example "$ARCHIVE_NAME/"
        cp build/*.so* "$ARCHIVE_NAME/" 2>/dev/null || true
        cp -r images "$ARCHIVE_NAME/"
        tar -czf "$ARCHIVE_NAME.tar.gz" "$ARCHIVE_NAME"
        echo "ASSET_PATH=$ARCHIVE_NAME.tar.gz" >> $GITHUB_ENV
    
    - name: Upload Release Asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.ASSET_PATH }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}