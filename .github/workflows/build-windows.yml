name: Windows Build

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - 'README.md'
      - 'LICENSE'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - 'README.md'
      - 'LICENSE'

jobs:
  build:
    name: Build Qt6 on Windows
    runs-on: windows-latest
    
    strategy:
      matrix:
        qt_version: ['6.5.3', '6.6.1']
        include:
          - qt_version: '6.5.3'
            qt_arch: 'win64_msvc2019_64'
          - qt_version: '6.6.1'
            qt_arch: 'win64_msvc2019_64'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Cache Qt installation
      uses: actions/cache@v3
      with:
        path: ${{ env.Qt6_DIR }}
        key: ${{ runner.os }}-qt-${{ matrix.qt_version }}-${{ matrix.qt_arch }}
        restore-keys: |
          ${{ runner.os }}-qt-${{ matrix.qt_version }}-
          ${{ runner.os }}-qt-
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: ${{ matrix.qt_version }}
        target: desktop
        arch: ${{ matrix.qt_arch }}
        cache: true
        modules: 'qtwebengine qtnetworkauth'
    
    - name: Setup MSVC environment
      uses: ilammy/msvc-dev-cmd@v1
    
    - name: Configure CMake
      run: |
        cmake -B build -G "Ninja" `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="$env:Qt6_DIR" `
          -DCMAKE_CXX_STANDARD=17
    
    - name: Build project
      run: |
        cmake --build build --config Release --parallel
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: example-windows-${{ matrix.qt_version }}
        path: |
          build/example.exe
          build/*.dll
        retention-days: 7
    
    - name: Package application
      if: startsWith(github.ref, 'refs/tags/')
      shell: pwsh
      run: |
        $env:ARCHIVE_NAME = "example-${{ github.ref_name }}-windows-qt${{ matrix.qt_version }}"
        New-Item -ItemType Directory -Path $env:ARCHIVE_NAME -Force
        Copy-Item -Path build\example.exe -Destination $env:ARCHIVE_NAME\ -Force
        Copy-Item -Path build\*.dll -Destination $env:ARCHIVE_NAME\ -Force -ErrorAction SilentlyContinue
        Copy-Item -Path images -Destination $env:ARCHIVE_NAME\ -Recurse -Force
        Compress-Archive -Path $env:ARCHIVE_NAME -DestinationPath "$env:ARCHIVE_NAME.zip" -Force
        echo "ASSET_PATH=$env:ARCHIVE_NAME.zip" >> $env:GITHUB_ENV
    
    - name: Upload Release Asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ env.ASSET_PATH }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
